<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>FedRAMP Machine Readable JSON Editor</title>

    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">

    <script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@latest/dist/jsoneditor.min.js"></script>

    <style>
        .container {
            max-width: 960px;
            margin: 0 auto
        }
    </style>
</head>
<body>
<div class='container'>
    <div class='columns'>
        <h1 class='col-md-12'>FedRAMP Machine Readable JSON Editor</h1>
    </div>

    <div><a href="http://localhost:63342/docs/tools/json-editor.html?data=FRMR.KSI.key-security-indicators.json&schema=http://localhost:63342/docs/tools/templates/FedRAMP.schema.json">Load with local schema</a></div>

    <div class='columns'>
        <div class='column col-md-12'>
            <button id='save' class='tiny'>Save Result As File</button>
            <button id='restore' class='secondary tiny'>Restore to Default</button>
            <span id='valid_indicator' class='label'></span>
        </div>
    </div>
    <div class='columns'>
        <div class='column col-md-12' id='editor'></div>
    </div>
</div>

<script>
    const params = new URLSearchParams(window.location.search);
    const schemaUrl = params.get('schema') || 'https://raw.githubusercontent.com/FedRAMP/docs/refs/heads/main/tools/templates/FedRAMP.schema.json';
    const filename = params.get('data');
    const dataUrl = "https://raw.githubusercontent.com/FedRAMP/docs/refs/heads/main/data/" + filename;
    const editor = document.getElementById('editor');

    const schemaPromise = fetch(schemaUrl).then(response => response.json());
    const dataPromise = dataUrl ? fetch(dataUrl).then(response => response.json()) : Promise.resolve(null);

    Promise.all([schemaPromise, dataPromise])
        .then(([schema, data]) => {
            // Override default behavior to show descriptions as tooltips for ALL fields
                    const originalAfterInputReady = JSONEditor.AbstractEditor.prototype.afterInputReady;
                    JSONEditor.AbstractEditor.prototype.afterInputReady = function () {
                        if (originalAfterInputReady) originalAfterInputReady.call(this);

                        // Apply tooltip only if description and label exist
                        if (this.schema.description && this.label && this.description) {
                            this.label.classList.add('tooltip', 'tooltip-right');
                            this.label.setAttribute('data-tooltip', this.schema.description);
                            this.description.style.display = 'none';
                        }
                    };
                const options = {
                    schema: schema,
                    theme: 'spectre',
                    iconlib: 'spectre',
                    ajax: true,
                };
                if (data) {
                    options.startval = data;
                }
                const jseditor = new JSONEditor(editor, options);

                jseditor.on('ready', function () {
                    // // Move descriptions to tooltips
                    //     for (const key in jseditor.editors) {
                    //         if (jseditor.editors.hasOwnProperty(key)) {
                    //             const ed = jseditor.editors[key];
                    //             // Check if the editor has a description, a label element, and a description element
                    //             if (ed.schema.description && ed.label && ed.description) {
                    //                 // Method 1: Use Spectre.css tooltips (since you are using the Spectre theme)
                    //                 ed.label.classList.add('tooltip', 'tooltip-right');
                    //                 ed.label.setAttribute('data-tooltip', ed.schema.description);
                    //
                    //                 // Method 2: Use standard browser tooltip (Uncomment if Method 1 has layout issues)
                    //                 // ed.label.setAttribute('title', ed.schema.description);
                    //
                    //                 // Hide the original description text block
                    //                 ed.description.style.display = 'none';
                    //             }
                    //         }
                    //     }
                    // let button = jseditor.root.getButton('Save Result As File', 'save', 'Save Result As File'),
                    //     button_holder = jseditor.root.theme.getHeaderButtonHolder();
                    // button_holder.appendChild(button);
                    // jseditor.root.header.parentNode.insertBefore(button_holder, jseditor.root.header.nextSibling);

                    function handleSaveButtonClick(e) {
                        e.preventDefault();
                        const output = jseditor.getValue();
                        output.$schema = "https://json-schema.org/draft/2020-12/schema";
                        output.$id = "FedRAMP.schema.json";

                        const blob = new Blob([JSON.stringify(output, null, 2)], {
                            type: "application/json;charset=utf-8"
                        });

                        if (window.navigator && window.navigator.msSaveOrOpenBlob) {
                            window.navigator.msSaveOrOpenBlob(blob, filename);
                        } else {
                            const a = document.createElement('a');
                            a.download = filename || 'fedramp-output.json';
                            a.href = URL.createObjectURL(blob);
                            a.dataset.downloadurl = ['text/plain', a.download, a.href].join(':');

                            a.dispatchEvent(new MouseEvent('click', {
                                'view': window,
                                'bubbles': true,
                                'cancelable': false
                            }));
                        }
                    }

                    // button.addEventListener('click', handleSaveButtonClick, false);
                    // Hook up the Restore to Default button
                    document.getElementById('save').addEventListener('click', handleSaveButtonClick);
                    // Hook up the Restore to Default button
                    document.getElementById('restore').addEventListener('click', function () {
                        jseditor.setValue(data);

                        // Hook up the validation indicator to update its
                        // status whenever the editor changes
                        jseditor.on('change', function () {
                            // Get an array of errors from the validator
                            var errors = editor.validate();

                            var indicator = document.getElementById('valid_indicator');

                            // Not valid
                            if (errors.length) {
                                indicator.className = 'label alert';
                                indicator.textContent = 'not valid';
                            }
                            // Valid
                            else {
                                indicator.className = 'label success';
                                indicator.textContent = 'valid';
                            }
                        });
                    });
                });
            }
        )
    ;


</script>
</body>
</html>
